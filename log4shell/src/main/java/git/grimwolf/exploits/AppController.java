package git.grimwolf.exploits;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class AppController {
	@Autowired
	private JdbcTemplate jdbcTemplate;

	private static final Logger logger = LogManager.getLogger("User Actions");

	@GetMapping("/api")
	public @ResponseBody String index(@RequestHeader("X-Api-Version") String apiVersion) {
		logger.info("Received a request for API version " + apiVersion);
		return "hi";
	}

	@GetMapping("/")
	public String index() {
		logger.info("Received Web Request");
		return "index";
	}

	@RequestMapping(value = "/", method = RequestMethod.POST)
	public String addMoveRequest(@ModelAttribute("SpringWeb") MoveRequest mr, ModelMap model) {
		model.addAttribute("fname", mr.getFname());
		model.addAttribute("lname", mr.getLname());
		model.addAttribute("email", mr.getEmail());
		addMRs(mr);
		logger.info("Recieved Movement Request: \n");
		return "index";
	}

	private void addMRs(MoveRequest mr) {
		String sql = String.format(
				"INSERT INTO MoveRequests (fname, lname, minitial, equipnum, src, dst, dbt, det, pnum, email)"
						+ "Values('%s', '%s', '%s', %d, '%s', '%s', '%s', '%s', '%s', '%s');",
				mr.getFname(), mr.getLname(), mr.getMinitial(), mr.getEquipnum(), mr.getsrc(), mr.getdst(), mr.getDbt(),
				mr.getDet(), mr.getPnum(), mr.getEmail());
		int[] x = jdbcTemplate.batchUpdate(sql);
		System.out.println(mr.toString());

	}

}